<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Dashboard - IT Support</title>
    <script src="../../assets/js/utils/config.js"></script>
    <script
      type="module"
      src="../../assets/js/utils/firebase-config.js"
    ></script>
    <link
      rel="icon"
      type="image/x-icon"
      href="../../assets/images/meitech.png"
    />
    <!-- Tambahkan di head -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.43/moment-timezone-with-data.min.js"></script>

    <!-- Styles -->
    <link rel="stylesheet" href="../../assets/css/base/styles.css" />
    <link rel="stylesheet" href="../../assets/css/pages/dashboard.css" />

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    />

    <!-- SweetAlert2 -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"
    />
    <style>
      .dashboard-columns {
        display: grid;
        grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
        gap: 1.25rem;
        align-items: start;
      }
      .left-pane,
      .right-pane {
        min-width: 0;
      }
      .right-pane {
        overflow: hidden;
      }
      .tickets-section {
        position: relative;
      }
      .left-pane .ticket-section,
      .left-pane #itAssignmentSection {
        margin-bottom: 1rem;
      }
      .tickets-table-wrap {
        overflow: hidden;
      }
      .tickets-table {
        width: 100%;
        max-width: 100%;
        table-layout: auto;
        border-collapse: collapse;
      }
      .tickets-table thead th {
        position: sticky;
        top: 0;
        background: var(--gray-50);
        z-index: 1;
      }
      html[data-theme="dark"] .tickets-table thead th {
        background: var(--gray-100);
      }
      .tickets-table th,
      .tickets-table td {
        padding: 4px !important;
        font-size: 0.85rem;
        line-height: 1.2;
        white-space: normal;
        word-break: normal;
        overflow: visible;
      }
      .row-meta {
        display: none;
        margin-top: 4px;
        gap: 6px;
        flex-wrap: wrap;
      }
      .row-meta .meta-chip {
        display: inline-block;
        font-size: 0.72rem;
        padding: 2px 6px;
        border: 1px solid var(--gray-200);
        border-radius: 6px;
        color: var(--gray-700);
      }
      html[data-theme="dark"] .row-meta .meta-chip {
        border-color: var(--gray-300);
        color: var(--gray-800);
      }
      .meta-chip.priority-low {
        background: #e9f7ef;
        border-color: #bfe7cf;
        color: #0f5132;
      }
      .meta-chip.priority-medium {
        background: #fff4e6;
        border-color: #ffd8a8;
        color: #7c2d12;
      }
      .meta-chip.priority-high {
        background: #fee2e2;
        border-color: #fca5a5;
        color: #7f1d1d;
      }
      html[data-theme="dark"] .meta-chip.priority-low {
        background: #18392a;
        border-color: #285a41;
        color: #cde7d6;
      }
      html[data-theme="dark"] .meta-chip.priority-medium {
        background: #3b2f1e;
        border-color: #5c492e;
        color: #ffe7c2;
      }
      html[data-theme="dark"] .meta-chip.priority-high {
        background: #3b1f20;
        border-color: #5c2b2d;
        color: #ffd1d1;
      }
      .meta-chip.status-open {
        background: #e0f2fe;
        border-color: #93c5fd;
        color: #1e3a8a;
      }
      .meta-chip.status-in-progress {
        background: #ede9fe;
        border-color: #c4b5fd;
        color: #3730a3;
      }
      .meta-chip.status-resolved {
        background: #e9f7ef;
        border-color: #bfe7cf;
        color: #0f5132;
      }
      html[data-theme="dark"] .meta-chip.status-open {
        background: #102a43;
        border-color: #1e3a8a;
        color: #cfe8ff;
      }
      html[data-theme="dark"] .meta-chip.status-in-progress {
        background: #1f2040;
        border-color: #3730a3;
        color: #e5deff;
      }
      html[data-theme="dark"] .meta-chip.status-resolved {
        background: #18392a;
        border-color: #285a41;
        color: #cde7d6;
      }
      .tickets-table th:nth-child(2),
      .tickets-table td:nth-child(2) {
        min-width: 200px;
      }
      .tickets-table th:nth-child(1),
      .tickets-table td:nth-child(1) {
        width: 84px;
      }
      .tickets-table th:nth-child(3),
      .tickets-table td:nth-child(3) {
        width: 100px;
      }
      .tickets-table th:nth-child(4),
      .tickets-table td:nth-child(4) {
        width: 72px;
      }
      .tickets-table th:nth-child(5),
      .tickets-table td:nth-child(5) {
        width: 96px;
      }
      .tickets-table th:nth-child(6),
      .tickets-table td:nth-child(6) {
        width: 120px;
      }
      .tickets-table th:nth-child(7),
      .tickets-table td:nth-child(7) {
        width: 84px;
        white-space: nowrap;
        font-variant-numeric: tabular-nums;
      }
      .tickets-table th:nth-child(8),
      .tickets-table td:nth-child(8) {
        width: 84px;
      }
      @media (max-width: 900px) {
        .tickets-table-wrap {
          overflow: hidden;
        }
        .tickets-table thead {
          display: none;
        }
        .tickets-table tr {
          display: block;
          border: 1px solid var(--gray-200);
          border-radius: 8px;
          margin-bottom: 12px;
          background: var(--gray-50);
        }
        html[data-theme="dark"] .tickets-table tr {
          background: var(--gray-100);
        }
        .tickets-table td {
          display: grid;
          grid-template-columns: 140px 1fr;
          align-items: start;
        }
        .tickets-table td::before {
          content: attr(data-label);
          font-weight: 600;
          color: var(--gray-600);
          padding-right: 8px;
        }
      }
      @media (max-width: 1200px) {
        .tickets-table th:nth-child(6), .tickets-table td:nth-child(6), /* Assigned */
        .tickets-table th:nth-child(7), .tickets-table td:nth-child(7)  /* Created */ {
          display: none;
        }
        .tickets-table td:nth-child(2) .row-meta {
          display: flex;
        }
      }
      @media (max-width: 1050px) {
        .tickets-table th:nth-child(3), .tickets-table td:nth-child(3) /* Location */ {
          display: none;
        }
        .tickets-table td:nth-child(2) .row-meta {
          display: flex;
        }
      }
      @media (max-width: 1024px) {
        .dashboard-columns {
          grid-template-columns: 1fr;
        }
      }
      #userTicketsTableFooter {
        position: sticky;
        bottom: 0;
        background: var(--gray-50);
        padding-top: 6px;
      }
      html[data-theme="dark"] #userTicketsTableFooter {
        background: var(--gray-100);
      }
      #userTicketsFilterBar {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
        margin-top: 8px;
        background: var(--gray-50);
        border: 1px solid var(--gray-200);
        border-radius: 8px;
        padding: 8px 10px;
      }
      html[data-theme="dark"] #userTicketsFilterBar {
        background: var(--gray-100);
        border-color: var(--gray-300);
      }
      #userTicketsFilterBar label {
        color: var(--gray-700);
        font-size: 0.85rem;
      }
      html[data-theme="dark"] #userTicketsFilterBar label {
        color: var(--gray-800);
      }
      #userTicketsFilterBar .form-control,
      #userTicketsFilterBar select,
      #userTicketsFilterBar input[type="date"] {
        height: 32px;
        padding: 4px 8px;
        border: 1px solid var(--gray-200);
        border-radius: 6px;
        background: var(--white);
        color: var(--black);
      }
      html[data-theme="dark"] #userTicketsFilterBar .form-control,
      html[data-theme="dark"] #userTicketsFilterBar select,
      html[data-theme="dark"] #userTicketsFilterBar input[type="date"] {
        background: var(--gray-100);
        border-color: var(--gray-300);
        color: var(--black);
      }
      #userTicketsFilterBar .form-control:focus,
      #userTicketsFilterBar select:focus,
      #userTicketsFilterBar input[type="date"]:focus {
        outline: none;
        border-color: var(--primary);
      }
      #userFilterClear {
        height: 32px;
      }

      /* Mobile header optimization */
      @media (max-width: 600px) {
        .dashboard-header {
          padding: 8px 12px;
        }
        .dashboard-header .header-content {
          display: grid;
          grid-template-columns: auto 1fr;
          align-items: center;
          gap: 8px;
        }
        .logo-section {
          display: flex;
          align-items: center;
        }
        .logo-section .dashboard-logo {
          height: 36px;
          width: auto;
        }
        .header-text {
          display: none;
        }
        .user-menu {
          display: flex;
          justify-content: flex-end;
          align-items: center;
          gap: 8px;
        }
        .user-info {
          display: flex;
          flex-direction: column;
          gap: 2px;
        }
        .user-name {
          font-size: 1rem;
          line-height: 1.2;
        }
        .user-email {
          display: none;
        }
        .header-actions {
          display: flex !important;
          flex-direction: row;
          align-items: center;
          gap: 6px;
        }
        .header-actions .theme-toggle {
          height: 36px;
          width: 36px;
          display: inline-flex;
          align-items: center;
          justify-content: center;
        }
        .header-actions button {
          height: 36px;
          min-width: 36px;
          padding: 0;
        }
        .header-actions .btn-profile,
        .header-actions .btn-logout {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          width: 32px;
          overflow: hidden;
          text-indent: -9999px;
          background: transparent !important;
          color: var(--primary) !important;
          border: 1px solid var(--primary);
          border-radius: 8px;
        }
        .header-actions .btn-profile i,
        .header-actions .btn-logout i {
          text-indent: 0;
          font-size: 16px;
          margin: 0;
        }
        .header-actions .btn-profile:hover,
        .header-actions .btn-logout:hover {
          background: var(--primary) !important;
          color: var(--white) !important;
        }
      }
    </style>
  </head>

  <body class="dashboard-body">
    <!-- Header -->
    <header class="dashboard-header">
      <div class="header-content">
        <div class="logo-section">
          <img
            src="../../assets/images/meitech-logo.png"
            alt="Meitech"
            class="dashboard-logo"
          />
          <div class="header-text">
            <h1>IT Support Ticketing System</h1>
            <p>User Dashboard</p>
          </div>
        </div>

        <div class="user-menu">
          <div class="user-info">
            <div class="user-name" id="userName">Loading...</div>
            <div class="user-email" id="userEmail">Loading...</div>
          </div>
          <div class="header-actions">
            <button class="theme-toggle theme-floating" id="themeToggleBtn">
              <i class="fas fa-moon"></i>
            </button>
            <button class="btn-profile" id="profileBtn">
              <i class="fas fa-user-edit"></i>
              Edit Profile
            </button>
            <button class="btn-logout" id="logoutBtn">
              <i class="fas fa-sign-out-alt"></i>
              Logout
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main id="dashboardMain" class="dashboard-main" style="visibility: hidden">
      <div class="dashboard-container">
        <!-- Profile Edit Modal -->
        <div id="profileModal" class="modal" style="display: none">
          <div class="modal-content">
            <div class="modal-header">
              <h2><i class="fas fa-user-edit"></i> Edit Profile</h2>
              <button class="modal-close" id="closeProfileModal">
                &times;
              </button>
            </div>
            <form id="profileForm" class="profile-form">
              <div class="form-row">
                <div class="form-group">
                  <label for="edit_employee_id">Employee ID</label>
                  <input
                    type="text"
                    id="edit_employee_id"
                    name="employee_id"
                    readonly
                    class="readonly-field"
                  />
                </div>
                <div class="form-group">
                  <label for="edit_full_name">Full Name *</label>
                  <input
                    type="text"
                    id="edit_full_name"
                    name="full_name"
                    required
                  />
                </div>
              </div>

              <div class="form-group">
                <label for="edit_email">Email Address *</label>
                <input type="email" id="edit_email" name="email" required />
              </div>

              <div class="form-group">
                <label for="edit_phone">Phone Number</label>
                <input
                  type="tel"
                  id="edit_phone"
                  name="phone"
                  placeholder="+62 XXX-XXXX-XXXX"
                />
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="edit_department">Department *</label>
                  <select id="edit_department" name="department" required>
                    <option value="">Select Department</option>
                    <option value="Admin">Admin</option>
                    <option value="Civil">Civil</option>
                    <option value="Clinic">Clinic</option>
                    <option value="Client">Client</option>
                    <option value="Completion">Completion</option>
                    <option value="DC">Dimentional Control (DC)</option>
                    <option value="Document Control">Document Control</option>
                    <option value="Engineer">Engineering</option>
                    <option value="Finance">Finance</option>
                    <option value="HSE">HSE</option>
                    <option value="HR">Human Resources (HRD)</option>
                    <option value="IT">IT</option>
                    <option value="Lainlain">Other Department</option>
                    <option value="Maintenance">Maintenance</option>
                    <option value="Management">Management</option>
                    <option value="PGA">PGA</option>
                    <option value="Planner">Planner</option>
                    <option value="Procurement">Procurement</option>
                    <option value="QC">Quality Control (QC)</option>
                    <option value="Vendor">Vendor</option>
                    <option value="Warehouse">Warehouse</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="edit_location">Location *</label>
                  <select id="edit_location" name="location" required>
                    <option value="">Select Location</option>
                    <option value="Blue Office">Blue Office</option>
                    <option value="Clinic">Clinic</option>
                    <option value="Control Room">Control Room</option>
                    <option value="Dark Room">Dark Room</option>
                    <option value="Green Office">Green Office</option>
                    <option value="HRD">HR Department</option>
                    <option value="HSE Yard">HSE Yard</option>
                    <option value="IT Server">IT Server</option>
                    <option value="IT Store">IT Store</option>
                    <option value="Multi Purposes Building">
                      Multi Purposes Building
                    </option>
                    <option value="Red Office">Red Office</option>
                    <option value="Security">Security</option>
                    <option value="Store 1">Store 1</option>
                    <option value="Store 2">Store 2</option>
                    <option value="Store 3">Store 3</option>
                    <option value="Store 4">Store 4</option>
                    <option value="Store 5">Store 5</option>
                    <option value="Store 6">Store 6</option>
                    <option value="Warehouse">Warehouse</option>
                    <option value="White Office">White Office</option>
                    <option value="White Office 2nd Fl">
                      White Office 2nd Floor
                    </option>
                    <option value="White Office 3rd Fl">
                      White Office 3rd Floor
                    </option>
                    <option value="Welding School">Welding School</option>
                    <option value="Workshop9">Workshop 9</option>
                    <option value="Workshop10">Workshop 10</option>
                    <option value="Workshop11">Workshop 11</option>
                    <option value="Workshop12">Workshop 12</option>
                    <option value="Yard">Yard</option>
                    <option value="Rest Area">Rest Area</option>
                    <option value="Lainlain">Other Location</option>
                  </select>
                </div>
              </div>

              <div class="form-actions">
                <button type="submit" class="btn-primary">
                  <i class="fas fa-save"></i>
                  Update Profile
                </button>
                <button
                  type="button"
                  class="btn-secondary"
                  id="cancelProfileEdit"
                >
                  Cancel
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Welcome Section -->
        <section class="welcome-section">
          <div class="welcome-card">
            <div class="welcome-content">
              <h2>Welcome back, <span id="welcomeUserName">User</span>!</h2>
              <p>
                Create a new support ticket or check the status of your existing
                tickets.
              </p>
            </div>
            <div class="welcome-stats">
              <div class="stat-item">
                <div class="stat-number" id="openTickets">0</div>
                <div class="stat-label">Open Tickets</div>
              </div>
              <div class="stat-item">
                <div class="stat-number" id="resolvedTickets">0</div>
                <div class="stat-label">Resolved</div>
              </div>
            </div>
          </div>
        </section>
        <div class="dashboard-columns">
          <div class="left-pane">
            <section
              id="itAssignmentSection"
              class="ticket-section"
              style="display: none"
            >
              <div class="section-header">
                <h2><i class="fas fa-tasks"></i> IT Assignments</h2>
                <p>Create assignment for all IT or a specific member</p>
              </div>

              <form id="assignmentForm" class="ticket-form">
                <div class="form-section">
                  <h3 class="section-title">Assignment Details</h3>
                  <div class="form-row">
                    <div class="form-group">
                      <label for="assignment_scope"
                        ><span class="required">Scope</span></label
                      >
                      <select id="assignment_scope" name="scope" required>
                        <option value="" disabled selected>Select Scope</option>
                        <option value="all">All IT Members</option>
                        <option value="single">Specific IT Member</option>
                      </select>
                    </div>
                    <div
                      class="form-group"
                      id="assignmentMemberGroup"
                      style="display: none"
                    >
                      <label for="assignment_member">Select Member</label>
                      <select id="assignment_member" name="member_uid">
                        <option value="" disabled selected>
                          Select IT Member
                        </option>
                      </select>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label for="assignment_subject">Subject</label>
                      <input
                        type="text"
                        id="assignment_subject"
                        placeholder="Short title for assignment"
                      />
                    </div>
                    <div class="form-group">
                      <label for="assignment_message">Message</label>
                      <textarea
                        id="assignment_message"
                        rows="3"
                        placeholder="Additional notes/instructions for this assignment"
                      ></textarea>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label for="assignment_activity"
                        ><span class="required">Activity</span></label
                      >
                      <select id="assignment_activity" name="activity" required>
                        <option value="" disabled selected>
                          Select Activity
                        </option>
                        <option value="Weekly Safety Talk">
                          Weekly Safety Talk
                        </option>
                        <option value="Ceremony Sail Away">
                          Ceremony Sail Away
                        </option>
                        <option value="Deliver">Deliver</option>
                        <option value="Software Install">
                          Software Install
                        </option>
                        <option value="Setup Meeting">Setup Meeting</option>
                        <option value="Drone Update Area">
                          Drone Update Area
                        </option>
                        <option value="Drone Lifting">Drone Lifting</option>
                        <option value="Stand By Meeting">
                          Stand By Meeting
                        </option>
                        <option value="Stand By Sunday">Stand By Sunday</option>
                        <option value="Back Up Data">Back Up Data</option>
                        <option value="Network">Network</option>
                        <option value="Connect Share Folder">
                          Connect Share Folder
                        </option>
                        <option value="Software Config">Software Config</option>
                        <option value="Install IT Standard Apps">
                          Install IT Standard Apps
                        </option>
                        <option value="Reinstall Windows">
                          Reinstall Windows
                        </option>
                        <option value="Other">Other</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label for="assignment_location"
                        ><span class="required">Location</span></label
                      >
                      <select id="assignment_location" name="location" required>
                        <option value="" disabled selected>
                          Select Location
                        </option>
                        <option value="Blue Office">Blue Office</option>
                        <option value="Clinic">Clinic</option>
                        <option value="Control Room">Control Room</option>
                        <option value="Dark Room">Dark Room</option>
                        <option value="Green Office">Green Office</option>
                        <option value="HRD">HR Department</option>
                        <option value="HSE Yard">HSE Yard</option>
                        <option value="IT Server">IT Server</option>
                        <option value="IT Store">IT Store</option>
                        <option value="Multi Purposes Building">
                          Multi Purposes Building
                        </option>
                        <option value="Red Office">Red Office</option>
                        <option value="Security">Security</option>
                        <option value="Store 1">Store 1</option>
                        <option value="Store 2">Store 2</option>
                        <option value="Store 3">Store 3</option>
                        <option value="Store 4">Store 4</option>
                        <option value="Store 5">Store 5</option>
                        <option value="Store 6">Store 6</option>
                        <option value="Warehouse">Warehouse</option>
                        <option value="White Office">White Office</option>
                        <option value="White Office 2nd Fl">
                          White Office 2nd Floor
                        </option>
                        <option value="White Office 3rd Fl">
                          White Office 3rd Floor
                        </option>
                        <option value="Welding School">Welding School</option>
                        <option value="Workshop9">Workshop 9</option>
                        <option value="Workshop10">Workshop 10</option>
                        <option value="Workshop11">Workshop 11</option>
                        <option value="Workshop12">Workshop 12</option>
                        <option value="Yard">Yard</option>
                        <option value="Rest Area">Rest Area</option>
                        <option value="Lainlain">Other Location</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label for="assignment_priority"
                        ><span class="required">Priority</span></label
                      >
                      <select id="assignment_priority" name="priority" required>
                        <option value="" disabled selected>
                          Select Priority
                        </option>
                        <option value="Low">Low</option>
                        <option value="Medium">Medium</option>
                        <option value="High">High</option>
                      </select>
                    </div>
                  </div>
                </div>

                <div class="form-actions">
                  <button
                    type="submit"
                    class="btn-primary"
                    id="submitAssignmentBtn"
                  >
                    <span class="btn-text">Create Assignment</span>
                    <div class="btn-loading" style="display: none">
                      <i class="fas fa-spinner fa-spin"></i>
                      Processing...
                    </div>
                  </button>
                </div>
              </form>
            </section>

            <!-- Ticket Form Section -->
            <section class="ticket-section">
              <div class="section-header">
                <h2><i class="fas fa-plus-circle"></i> Create New Ticket</h2>
                <p>Report a technical issue to our IT support team</p>
              </div>

              <form id="ticketForm" class="ticket-form">
                <!-- Device Information -->
                <div class="form-section">
                  <h3 class="section-title">Device Information</h3>
                  <div class="form-row">
                    <div class="form-group">
                      <label for="inventory">
                        <span class="required">Inventory Code</span>
                      </label>
                      <input
                        type="text"
                        name="inventory"
                        id="inventory"
                        required
                        placeholder="PCPRO-MEB001 / PC24001MEB / PRN24001MEB"
                      />
                    </div>

                    <div class="form-group">
                      <label for="device">
                        <span class="required">Device Type</span>
                      </label>
                      <select name="device" id="device" required>
                        <option value="" disabled selected>
                          Select Device Type
                        </option>
                        <option value="Backup Data">Backup Data</option>
                        <option value="Drone">Drone</option>
                        <option value="Laptop">Laptop</option>
                        <option value="Network">Network</option>
                        <option value="PC Hardware">PC Hardware</option>
                        <option value="PC Software">PC Software</option>
                        <option value="Printer">Printer</option>
                        <option value="Projector">Projector</option>
                        <option value="Others">Others</option>
                      </select>
                    </div>
                  </div>
                </div>

                <!-- Ticket Details -->
                <div class="form-section">
                  <h3 class="section-title">Ticket Details</h3>
                  <div class="form-row">
                    <div class="form-group">
                      <label for="location">
                        <span class="required">Location</span>
                      </label>
                      <select name="location" id="location" required>
                        <option value="" disabled selected>
                          Select Location
                        </option>
                        <option value="Blue Office">Blue Office</option>
                        <option value="Clinic">Clinic</option>
                        <option value="Control Room">Control Room</option>
                        <option value="Dark Room">Dark Room</option>
                        <option value="Green Office">Green Office</option>
                        <option value="HRD">HR Department</option>
                        <option value="HSE Yard">HSE Yard</option>
                        <option value="IT Server">IT Server</option>
                        <option value="IT Store">IT Store</option>
                        <option value="Multi Purposes Building">
                          Multi Purposes Building
                        </option>
                        <option value="Red Office">Red Office</option>
                        <option value="Security">Security</option>
                        <option value="Store 1">Store 1</option>
                        <option value="Store 2">Store 2</option>
                        <option value="Store 3">Store 3</option>
                        <option value="Store 4">Store 4</option>
                        <option value="Store 5">Store 5</option>
                        <option value="Store 6">Store 6</option>
                        <option value="Warehouse">Warehouse</option>
                        <option value="White Office">White Office</option>
                        <option value="White Office 2nd Fl">
                          White Office 2nd Floor
                        </option>
                        <option value="White Office 3rd Fl">
                          White Office 3rd Floor
                        </option>
                        <option value="Welding School">Welding School</option>
                        <option value="Workshop9">Workshop 9</option>
                        <option value="Workshop10">Workshop 10</option>
                        <option value="Workshop11">Workshop 11</option>
                        <option value="Workshop12">Workshop 12</option>
                        <option value="Yard">Yard</option>
                        <option value="Rest Area">Rest Area</option>
                        <option value="Lainlain">Other Location</option>
                      </select>
                    </div>

                    <div class="form-group">
                      <label for="priority">
                        <span class="required">Priority Level</span>
                      </label>
                      <select name="priority" id="priority" required>
                        <option value="" disabled selected>
                          Select Priority
                        </option>
                        <option value="Low">Low - Minor issue</option>
                        <option value="Medium">
                          Medium - Significant issue
                        </option>
                        <option value="High">High - Critical issue</option>
                      </select>
                    </div>
                  </div>
                </div>

                <!-- Issue Description -->
                <div class="form-section">
                  <h3 class="section-title">Issue Description</h3>
                  <div class="form-group">
                    <label for="subject">
                      <span class="required">Issue Summary</span>
                    </label>
                    <input
                      type="text"
                      name="subject"
                      id="subject"
                      required
                      placeholder="Brief summary of the issue"
                    />
                  </div>

                  <div class="form-group">
                    <label for="message">
                      <span class="required">Detailed Description</span>
                    </label>
                    <textarea
                      name="message"
                      id="message"
                      rows="4"
                      required
                      placeholder="Describe the issue in detail including error messages, steps to reproduce, and when it started"
                    ></textarea>
                  </div>
                </div>

                <!-- Hidden Fields -->
                <input type="hidden" name="user_id" id="user_id" />
                <input type="hidden" name="user_name" id="user_name" />
                <input type="hidden" name="user_email" id="user_email" />
                <input
                  type="hidden"
                  name="user_department"
                  id="user_department"
                />
                <input type="hidden" name="status" value="Open" />
                <input type="hidden" name="created_at" id="created_at" />

                <!-- Messages -->
                <div
                  id="ticketErrorMessage"
                  class="error-message"
                  style="display: none"
                ></div>
                <div
                  id="ticketSuccessMessage"
                  class="success-message"
                  style="display: none"
                ></div>

                <!-- Submit Button -->
                <div class="form-actions">
                  <button
                    type="submit"
                    class="btn-primary"
                    id="submitTicketBtn"
                  >
                    <span class="btn-text">Submit Ticket</span>
                    <div class="btn-loading" style="display: none">
                      <i class="fas fa-spinner fa-spin"></i>
                      Processing...
                    </div>
                  </button>
                  <button type="reset" class="btn-secondary">Clear Form</button>
                </div>
              </form>
            </section>
          </div>
          <div class="right-pane">
            <!-- Recent Tickets Section -->
            <section class="tickets-section">
              <div class="section-header">
                <h2><i class="fas fa-history"></i> Recent Tickets</h2>
                <p>Your recently submitted support tickets</p>
              </div>
              <div
                id="userTicketsFilterBar"
                style="
                  display: flex;
                  gap: 0.5rem;
                  align-items: center;
                  flex-wrap: wrap;
                  margin-top: 0.5rem;
                "
              >
                <label for="userStatusFilter" style="font-weight: 600"
                  >Status</label
                >
                <select
                  id="userStatusFilter"
                  class="form-control"
                  style="min-width: 160px"
                >
                  <option value="All" selected>All</option>
                  <option value="Open">Open</option>
                  <option value="In Progress">In Progress</option>
                  <option value="Pending">Pending</option>
                  <option value="Resolved">Resolved</option>
                </select>
                <label for="userDateStartFilter" style="font-weight: 600"
                  >From</label
                >
                <input
                  type="date"
                  id="userDateStartFilter"
                  class="form-control"
                  style="min-width: 160px"
                />
                <label for="userDateEndFilter" style="font-weight: 600"
                  >To</label
                >
                <input
                  type="date"
                  id="userDateEndFilter"
                  class="form-control"
                  style="min-width: 160px"
                />
                <button
                  id="userFilterClear"
                  class="btn-secondary"
                  style="margin-left: auto"
                >
                  Clear
                </button>
              </div>

              <div class="tickets-list" id="ticketsList">
                <div class="empty-state">
                  <i class="fas fa-ticket-alt"></i>
                  <h3>No tickets yet</h3>
                  <p>Submit your first support ticket above</p>
                </div>
              </div>
              <div id="ticketsListFooter" style="margin-top: 0.75rem"></div>
              <div
                class="tickets-table-wrap"
                id="userTicketsTableContainer"
                style="display: none; margin-top: 1rem"
              >
                <table
                  class="tickets-table"
                  id="userTicketsTable"
                  style="width: 100%; border-collapse: collapse"
                >
                  <thead>
                    <tr>
                      <th style="text-align: left; padding: 8px">Code</th>
                      <th style="text-align: left; padding: 8px">Subject</th>
                      <th style="text-align: left; padding: 8px">Location</th>
                      <th style="text-align: left; padding: 8px">Priority</th>
                      <th style="text-align: left; padding: 8px">Status</th>
                      <th style="text-align: left; padding: 8px">
                        Assigned To
                      </th>
                      <th style="text-align: left; padding: 8px">Created</th>
                      <th style="text-align: left; padding: 8px">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="userTicketsTableBody"></tbody>
                </table>
                <div
                  id="userTicketsTableFooter"
                  style="margin-top: 0.75rem"
                ></div>
              </div>
            </section>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="dashboard-footer">
      <div class="footer-content">
        <small>&copy; 2025 IT Support System 71001-04-8314</small>
        <small>For urgent issues, please contact IT Support directly</small>
      </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script type="module">
      import { auth, db } from "../../assets/js/utils/firebase-config.js";
      import {
        collection,
        query,
        where,
        getDocs,
        orderBy,
        limit,
        addDoc,
        serverTimestamp,
        doc,
        getDoc,
        updateDoc,
        setDoc,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
      import {
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      const setUserInfo = (email) => {
        const legacyName =
          (typeof window !== "undefined" && window.__legacyUser
            ? window.__legacyUser.name
            : null) || null;
        const name = legacyName || (email || "").split("@")[0] || "User";
        const n1 = document.getElementById("userName");
        const n2 = document.getElementById("welcomeUserName");
        const e1 = document.getElementById("userEmail");
        if (n1) n1.textContent = name;
        if (n2) n2.textContent = name;
        if (e1) e1.textContent = email || "";
      };
      const showMain = () => {
        const main = document.getElementById("dashboardMain");
        if (main) main.style.visibility = "visible";
      };
      document.addEventListener("DOMContentLoaded", () => {
        try {
          onAuthStateChanged(auth, async (cu) => {
            try {
              try {
                console.info("Auth state", {
                  uid: cu?.uid || null,
                  email: cu?.email || null,
                });
              } catch (_) {}
              let email = cu?.email || "";
              if (email) setUserInfo(email);
              else setUserInfo("User");
              showMain();
              const profileBtn = document.getElementById("profileBtn");
              const profileModal = document.getElementById("profileModal");
              const closeProfileModal =
                document.getElementById("closeProfileModal");
              const cancelProfileEdit =
                document.getElementById("cancelProfileEdit");
              const logoutBtn = document.getElementById("logoutBtn");
              if (logoutBtn) {
                logoutBtn.onclick = async () => {
                  const result = await Swal.fire({
                    title: "Logout?",
                    html: `<div style="text-align:left;">Anda yakin ingin keluar dari sesi ini?</div>`,
                    icon: "question",
                    confirmButtonText: "Logout",
                    cancelButtonText: "Batal",
                    confirmButtonColor: "#ef070a",
                    cancelButtonColor: "#6b7280",
                    reverseButtons: true,
                    showCancelButton: true,
                    focusCancel: true,
                  });
                  if (result.isConfirmed) {
                    Swal.fire({
                      title: "Logging out...",
                      allowOutsideClick: false,
                      showConfirmButton: false,
                      didOpen: () => {
                        Swal.showLoading();
                      },
                    });
                    try {
                      const timeout = new Promise((resolve) =>
                        setTimeout(resolve, 5000)
                      );
                      await Promise.race([signOut(auth), timeout]);
                    } catch (_) {}
                    try {
                      Swal.close();
                    } catch (_) {}
                    try {
                      window.location.href = "../auth/login.html";
                    } catch (_) {}
                  }
                };
              }
              const prefillProfile = async () => {
                const baseName = (email || "").split("@")[0] || "User";
                let data = null;
                try {
                  if (cu?.uid) {
                    const byId = await getDoc(doc(db, "users", cu.uid));
                    if (byId.exists()) data = byId.data();
                  }
                  if (!data && email) {
                    const q = await getDocs(
                      query(
                        collection(db, "users"),
                        where("email", "==", email.toLowerCase()),
                        limit(1)
                      )
                    );
                    if (q.docs[0]) data = q.docs[0].data();
                  }
                  if (!data && email) {
                    const qa = await getDocs(
                      query(
                        collection(db, "admins"),
                        where("email", "==", email.toLowerCase()),
                        limit(1)
                      )
                    );
                    if (qa.docs[0]) data = qa.docs[0].data();
                  }
                } catch (_) {}
                const f_employee = document.getElementById("edit_employee_id");
                const f_name = document.getElementById("edit_full_name");
                const f_email = document.getElementById("edit_email");
                const f_phone = document.getElementById("edit_phone");
                const f_dept = document.getElementById("edit_department");
                const f_loc = document.getElementById("edit_location");
                if (f_employee) f_employee.value = data?.employee_id || "";
                if (f_name)
                  f_name.value = data?.full_name || data?.name || baseName;
                if (f_email) f_email.value = data?.email || email || "";
                if (f_phone) f_phone.value = data?.phone || "";
                if (f_dept) f_dept.value = data?.department || "";
                if (f_loc) f_loc.value = data?.location || "";
              };
              if (profileBtn && profileModal) {
                profileBtn.onclick = async () => {
                  await prefillProfile();
                  profileModal.style.display = "block";
                };
              }
              if (closeProfileModal && profileModal) {
                closeProfileModal.onclick = () => {
                  profileModal.style.display = "none";
                };
              }
              if (cancelProfileEdit && profileModal) {
                cancelProfileEdit.onclick = () => {
                  profileModal.style.display = "none";
                };
              }
              if (email) {
                try {
                  let docUser = null;
                  if (cu?.uid) {
                    const byId = await getDoc(doc(db, "users", cu.uid));
                    if (byId.exists()) docUser = byId;
                  }
                  if (!docUser) {
                    const q1 = await getDocs(
                      query(
                        collection(db, "users"),
                        where("email", "==", email.toLowerCase()),
                        limit(1)
                      )
                    );
                    docUser = q1.docs[0] || null;
                  }
                  if (!docUser) {
                    const q2 = await getDocs(
                      query(
                        collection(db, "users"),
                        where("email", "==", email),
                        limit(1)
                      )
                    );
                    docUser = q2.docs[0] || null;
                  }
                  const baseName = (email || "").split("@")[0] || "User";
                  if (docUser) {
                    const u = docUser.data();
                    const n1 = document.getElementById("userName");
                    const n2 = document.getElementById("welcomeUserName");
                    const e1 = document.getElementById("userEmail");
                    if (n1) n1.textContent = u.full_name || u.name || baseName;
                    if (n2) n2.textContent = u.full_name || u.name || baseName;
                    if (e1) e1.textContent = u.email || email;
                    const userNameInput = document.getElementById("user_name");
                    const userEmailInput =
                      document.getElementById("user_email");
                    const userDeptInput =
                      document.getElementById("user_department");
                    if (userNameInput)
                      userNameInput.value = u.full_name || u.name || "";
                    if (userEmailInput) userEmailInput.value = u.email || "";
                    if (userDeptInput && u.department)
                      userDeptInput.value = u.department;
                    const f_employee =
                      document.getElementById("edit_employee_id");
                    const f_name = document.getElementById("edit_full_name");
                    const f_email = document.getElementById("edit_email");
                    const f_phone = document.getElementById("edit_phone");
                    const f_dept = document.getElementById("edit_department");
                    const f_loc = document.getElementById("edit_location");
                    if (f_employee) f_employee.value = u.employee_id || "";
                    if (f_name)
                      f_name.value = u.full_name || u.name || baseName;
                    if (f_email) f_email.value = u.email || email;
                    if (f_phone) f_phone.value = u.phone || "";
                    if (f_dept) f_dept.value = u.department || "";
                    if (f_loc) f_loc.value = u.location || "";
                  } else {
                    let adminDoc = null;
                    if (cu?.uid) {
                      const aById = await getDoc(doc(db, "admins", cu.uid));
                      if (aById.exists()) adminDoc = aById;
                    }
                    if (!adminDoc) {
                      const qa1 = await getDocs(
                        query(
                          collection(db, "admins"),
                          where("email", "==", email.toLowerCase()),
                          limit(1)
                        )
                      );
                      adminDoc = qa1.docs[0] || null;
                    }
                    if (!adminDoc) {
                      const qa2 = await getDocs(
                        query(
                          collection(db, "admins"),
                          where("email", "==", email),
                          limit(1)
                        )
                      );
                      adminDoc = qa2.docs[0] || null;
                    }
                    if (adminDoc) {
                      const a = adminDoc.data();
                      const n1 = document.getElementById("userName");
                      const n2 = document.getElementById("welcomeUserName");
                      const e1 = document.getElementById("userEmail");
                      if (n1)
                        n1.textContent = a.full_name || a.name || baseName;
                      if (n2)
                        n2.textContent = a.full_name || a.name || baseName;
                      if (e1) e1.textContent = a.email || email;
                      const f_employee =
                        document.getElementById("edit_employee_id");
                      const f_name = document.getElementById("edit_full_name");
                      const f_email = document.getElementById("edit_email");
                      const f_phone = document.getElementById("edit_phone");
                      const f_dept = document.getElementById("edit_department");
                      const f_loc = document.getElementById("edit_location");
                      if (f_employee) f_employee.value = a.employee_id || "";
                      if (f_name)
                        f_name.value = a.full_name || a.name || baseName;
                      if (f_email) f_email.value = a.email || email;
                      if (f_phone) f_phone.value = a.phone || "";
                      if (f_dept) f_dept.value = a.department || "";
                      if (f_loc) f_loc.value = a.location || "";
                      const userNameInput =
                        document.getElementById("user_name");
                      const userEmailInput =
                        document.getElementById("user_email");
                      const userDeptInput =
                        document.getElementById("user_department");
                      if (userNameInput)
                        userNameInput.value = a.full_name || a.name || "";
                      if (userEmailInput) userEmailInput.value = a.email || "";
                      if (userDeptInput && a.department)
                        userDeptInput.value = a.department;
                      if (cu?.uid) {
                        const ref = doc(db, "users", cu.uid);
                        const exists = await getDoc(ref);
                        if (!exists.exists()) {
                          const createData = {
                            employee_id: a.employee_id || "",
                            full_name: a.full_name || a.name || baseName,
                            email: (a.email || email || "").toLowerCase(),
                            phone: a.phone || "",
                            department: a.department || "",
                            location: a.location || "",
                            role: "user",
                            is_active: true,
                            created_at: new Date().toISOString(),
                          };
                          await setDoc(ref, createData);
                        }
                      }
                    } else {
                      const f_name = document.getElementById("edit_full_name");
                      const f_email = document.getElementById("edit_email");
                      if (f_name) f_name.value = baseName;
                      if (f_email) f_email.value = email;
                    }
                  }
                } catch (_) {}
              }
              const itSection = document.getElementById("itAssignmentSection");
              if (itSection) {
                const isIt = (email || "").toLowerCase() === "it@meb.com";
                if (isIt) itSection.style.display = "block";
                const scopeEl = document.getElementById("assignment_scope");
                const memberGroupEl = document.getElementById(
                  "assignmentMemberGroup"
                );
                const memberEl = document.getElementById("assignment_member");
                if (scopeEl) {
                  scopeEl.addEventListener("change", () => {
                    const v = scopeEl.value || "";
                    if (memberGroupEl)
                      memberGroupEl.style.display =
                        v === "single" ? "block" : "none";
                  });
                }
                try {
                  let adminsSnap;
                  try {
                    adminsSnap = await getDocs(
                      query(
                        collection(db, "admins"),
                        where("is_active", "==", true),
                        where("role", "in", [
                          "IT Engineer",
                          "IT Tech Support",
                          "IT Visual",
                        ])
                      )
                    );
                  } catch (_) {
                    try {
                      adminsSnap = await getDocs(
                        query(
                          collection(db, "admins"),
                          where("is_active", "==", true)
                        )
                      );
                    } catch (_) {
                      adminsSnap = null;
                    }
                  }
                  if (memberEl) {
                    memberEl.innerHTML =
                      '<option value="" disabled selected>Select IT Member</option>';
                    let arr = [];
                    if (adminsSnap && !adminsSnap.empty) {
                      adminsSnap.forEach((docSnap) => {
                        const d = docSnap.data() || {};
                        arr.push({ id: docSnap.id, data: d, source: "admins" });
                      });
                    } else {
                      try {
                        const usersSnap = await getDocs(
                          query(
                            collection(db, "users"),
                            where("role", "in", [
                              "Super Admin",
                              "IT Engineer",
                              "IT Tech Support",
                              "IT Visual",
                            ])
                          )
                        );
                        usersSnap.forEach((docSnap) => {
                          const d = docSnap.data() || {};
                          arr.push({
                            id: docSnap.id,
                            data: d,
                            source: "users",
                          });
                        });
                        if (arr.length === 0) {
                          const usersItSnap = await getDocs(
                            query(
                              collection(db, "users"),
                              where("department", "==", "IT")
                            )
                          );
                          usersItSnap.forEach((docSnap) => {
                            const d = docSnap.data() || {};
                            arr.push({
                              id: docSnap.id,
                              data: d,
                              source: "users",
                            });
                          });
                        }
                      } catch (_) {}
                    }
                    const preferred = [
                      "riko hermansyah",
                      "wahyu nugroho",
                      "abdurahman hakim",
                      "ade reinalwi",
                    ];
                    arr.sort((a, b) => {
                      const an = String(
                        a.data.name || a.data.full_name || a.data.email || ""
                      ).toLowerCase();
                      const bn = String(
                        b.data.name || b.data.full_name || b.data.email || ""
                      ).toLowerCase();
                      const ai = preferred.indexOf(an);
                      const bi = preferred.indexOf(bn);
                      if (ai !== -1 && bi === -1) return -1;
                      if (ai === -1 && bi !== -1) return 1;
                      return an.localeCompare(bn);
                    });
                    const seen = new Set();
                    arr.forEach(({ id, data, source }) => {
                      const emailVal = String(data.email || "").toLowerCase();
                      const key = emailVal || id;
                      if (seen.has(key)) return;
                      seen.add(key);
                      const text =
                        (data.name || data.full_name || data.email || id) +
                        (data.email ? ` (${data.email})` : "");
                      const opt = document.createElement("option");
                      opt.value = source === "admins" ? id : emailVal || id;
                      opt.textContent = text;
                      memberEl.appendChild(opt);
                    });
                    if (memberEl.options.length <= 1) {
                      [
                        { name: "Riko Hermansyah" },
                        { name: "Wahyu Nugroho" },
                        { name: "Abdurahman Hakim" },
                        { name: "Ade Reinalwi" },
                      ].forEach((p) => {
                        const opt = document.createElement("option");
                        opt.value = p.name.toLowerCase();
                        opt.textContent = p.name;
                        memberEl.appendChild(opt);
                      });
                    }
                  }
                } catch (_) {}
                const assignmentForm =
                  document.getElementById("assignmentForm");
                if (assignmentForm && isIt) {
                  assignmentForm.addEventListener("submit", async (e) => {
                    e.preventDefault();
                    const submitBtn = document.getElementById(
                      "submitAssignmentBtn"
                    );
                    const btnText = submitBtn?.querySelector(".btn-text");
                    const btnLoading = submitBtn?.querySelector(".btn-loading");
                    if (submitBtn) {
                      submitBtn.disabled = true;
                      if (btnText) btnText.style.display = "none";
                      if (btnLoading) btnLoading.style.display = "inline-block";
                    }
                    try {
                      const scope =
                        document.getElementById("assignment_scope")?.value ||
                        "";
                      const subject =
                        document.getElementById("assignment_subject")?.value ||
                        "";
                      const message =
                        document.getElementById("assignment_message")?.value ||
                        "";
                      const activity =
                        document.getElementById("assignment_activity")?.value ||
                        "";
                      const location =
                        document.getElementById("assignment_location")?.value ||
                        "";
                      const priority =
                        document.getElementById("assignment_priority")?.value ||
                        "Medium";
                      const memberUid =
                        document.getElementById("assignment_member")?.value ||
                        "";
                      let creatorName = (email || "").split("@")[0] || "User";
                      try {
                        if (cu?.uid) {
                          const udoc = await getDoc(doc(db, "users", cu.uid));
                          if (udoc.exists()) {
                            const ud = udoc.data() || {};
                            creatorName =
                              ud.full_name || ud.name || creatorName;
                          } else {
                            const adoc = await getDoc(
                              doc(db, "admins", cu.uid)
                            );
                            if (adoc.exists()) {
                              const ad = adoc.data() || {};
                              creatorName =
                                ad.full_name || ad.name || creatorName;
                            } else if (email) {
                              const uq = await getDocs(
                                query(
                                  collection(db, "users"),
                                  where(
                                    "email",
                                    "==",
                                    (email || "").toLowerCase()
                                  ),
                                  limit(1)
                                )
                              );
                              if (uq.docs[0]) {
                                const ud2 = uq.docs[0].data() || {};
                                creatorName =
                                  ud2.full_name || ud2.name || creatorName;
                              } else {
                                const aq = await getDocs(
                                  query(
                                    collection(db, "admins"),
                                    where(
                                      "email",
                                      "==",
                                      (email || "").toLowerCase()
                                    ),
                                    limit(1)
                                  )
                                );
                                if (aq.docs[0]) {
                                  const ad2 = aq.docs[0].data() || {};
                                  creatorName =
                                    ad2.full_name || ad2.name || creatorName;
                                }
                              }
                            }
                          }
                        }
                      } catch (_) {}
                      const payload = {
                        is_assignment: true,
                        assignment_scope: scope,
                        assignment_subject: subject,
                        assignment_message: message,
                        assignment_activity: activity,
                        assignment_location: location,
                        priority,
                        status: "Open",
                        created_at: serverTimestamp(),
                        created_by: cu?.uid || "",
                        created_by_email: (email || "").toLowerCase(),
                        user_id: cu?.uid || "",
                        user_email: (email || "").toLowerCase(),
                        user_name: creatorName,
                        user_department:
                          document.getElementById("user_department")?.value ||
                          "",
                        created_by_uid: cu?.uid || "",
                        created_by_name: creatorName,
                      };
                      if (!payload.user_department) {
                        try {
                          const udoc = await getDoc(
                            doc(db, "users", cu?.uid || "")
                          );
                          if (udoc.exists()) {
                            const ud = udoc.data() || {};
                            if (ud.department)
                              payload.user_department = ud.department;
                          } else if (cu?.uid) {
                            const adoc = await getDoc(
                              doc(db, "admins", cu.uid)
                            );
                            if (adoc.exists()) {
                              const ad = adoc.data() || {};
                              if (ad.department)
                                payload.user_department = ad.department;
                            }
                          }
                        } catch (_) {}
                      }
                      if (scope === "single" && memberUid) {
                        if (memberUid.includes("@")) {
                          payload.target_admin_email = memberUid.toLowerCase();
                        } else {
                          payload.target_admin_uid = memberUid;
                          try {
                            const adminDoc = await getDoc(
                              doc(db, "admins", memberUid)
                            );
                            if (adminDoc.exists()) {
                              const ad = adminDoc.data() || {};
                              payload.target_admin_email = (
                                ad.email || ""
                              ).toLowerCase();
                            } else {
                              const nameMap = {
                                "riko hermansyah": "riko.hermansyah@meb.com",
                                "wahyu nugroho": "wahyu.nugroho@meb.com",
                                "abdurahman hakim": "abdurahman.hakim@meb.com",
                                "ade reinalwi": "ade.reinalwi@meb.com",
                              };
                              const m = nameMap[memberUid.toLowerCase()];
                              if (m) payload.target_admin_email = m;
                            }
                          } catch (_) {
                            const nameMap = {
                              "riko hermansyah": "riko.hermansyah@meb.com",
                              "wahyu nugrogo": "wahyu.nugroho@meb.com",
                              "abdurahman hakim": "abdurahman.hakim@meb.com",
                              "ade reinalwi": "ade.reinalwi@meb.com",
                            };
                            const m = nameMap[memberUid.toLowerCase()];
                            if (m) payload.target_admin_email = m;
                          }
                        }
                      }
                      const docRef = await addDoc(
                        collection(db, "tickets"),
                        payload
                      );
                      try {
                        const code = window.generateTicketId(
                          payload.user_department || "IT",
                          activity || "Others",
                          location || "",
                          docRef.id,
                          activity || ""
                        );
                        await updateDoc(docRef, { code });
                      } catch (_) {}
                      try {
                        await Swal.fire({
                          icon: "success",
                          title: "Assignment Created",
                        });
                      } catch (_) {}
                      try {
                        assignmentForm.reset();
                        if (scopeEl) scopeEl.value = "";
                        if (memberEl) memberEl.value = "";
                      } catch (_) {}
                    } catch (err) {
                      try {
                        await Swal.fire({
                          icon: "error",
                          title: "Create Failed",
                          text: err?.message || "",
                        });
                      } catch (_) {}
                    } finally {
                      if (submitBtn) {
                        submitBtn.disabled = false;
                        if (btnText) btnText.style.display = "block";
                        if (btnLoading) btnLoading.style.display = "none";
                      }
                    }
                  });
                }
              }
              const profileForm = document.getElementById("profileForm");
              if (profileForm && cu?.uid) {
                profileForm.onsubmit = async (e) => {
                  try {
                    e.preventDefault();
                  } catch (_) {}
                  try {
                    const fd = new FormData(profileForm);
                    const d = Object.fromEntries(fd.entries());
                    const updates = {
                      employee_id: d.employee_id || "",
                      full_name: d.full_name || "",
                      email: (d.email || email || "").toLowerCase(),
                      phone: d.phone || "",
                      department: d.department || "",
                      location: d.location || "",
                      role: "user",
                      is_active: true,
                      updated_at: new Date().toISOString(),
                    };
                    const ref = doc(db, "users", cu.uid);
                    const existing = await getDoc(ref);
                    if (existing.exists()) {
                      await updateDoc(ref, updates);
                    } else {
                      await setDoc(ref, {
                        ...updates,
                        created_at: new Date().toISOString(),
                      });
                    }
                    const n1 = document.getElementById("userName");
                    const n2 = document.getElementById("welcomeUserName");
                    const e1 = document.getElementById("userEmail");
                    if (n1)
                      n1.textContent = updates.full_name || n1.textContent;
                    if (n2)
                      n2.textContent = updates.full_name || n2.textContent;
                    if (e1) e1.textContent = updates.email || e1.textContent;
                    const userNameInput = document.getElementById("user_name");
                    const userEmailInput =
                      document.getElementById("user_email");
                    const userDeptInput =
                      document.getElementById("user_department");
                    if (userNameInput)
                      userNameInput.value = updates.full_name || "";
                    if (userEmailInput)
                      userEmailInput.value = updates.email || "";
                    if (userDeptInput)
                      userDeptInput.value = updates.department || "";
                    try {
                      Swal.fire({ icon: "success", title: "Profile updated" });
                    } catch (_) {}
                    try {
                      profileModal.style.display = "none";
                    } catch (_) {}
                  } catch (err) {
                    try {
                      Swal.fire({
                        icon: "error",
                        title: "Update failed",
                        text: err?.message || "",
                      });
                    } catch (_) {}
                  }
                };
              }
              const uid = cu?.uid || "";
              const tasks = [];
              if (uid) {
                try {
                  tasks.push(
                    getDocs(
                      query(
                        collection(db, "tickets"),
                        where("user_id", "==", uid),
                        limit(100)
                      )
                    )
                  );
                } catch (_) {
                  tasks.push(
                    getDocs(
                      query(
                        collection(db, "tickets"),
                        where("user_id", "==", uid),
                        limit(100)
                      )
                    )
                  );
                }
                tasks.push(
                  getDocs(
                    query(
                      collection(db, "tickets"),
                      where("userId", "==", uid),
                      limit(100)
                    )
                  )
                );
                tasks.push(
                  getDocs(
                    query(
                      collection(db, "tickets"),
                      where("created_by", "==", uid),
                      limit(100)
                    )
                  )
                );
                tasks.push(
                  getDocs(
                    query(
                      collection(db, "tickets"),
                      where("created_by_uid", "==", uid),
                      limit(100)
                    )
                  )
                );
              }
              if (email) {
                const em = email.toLowerCase();
                tasks.push(
                  getDocs(
                    query(
                      collection(db, "tickets"),
                      where("user_email", "==", em),
                      limit(200)
                    )
                  )
                );
                tasks.push(
                  getDocs(
                    query(
                      collection(db, "tickets"),
                      where("email", "==", em),
                      limit(200)
                    )
                  )
                );
                tasks.push(
                  getDocs(
                    query(
                      collection(db, "tickets"),
                      where("user_email", "==", email),
                      limit(200)
                    )
                  )
                );
                tasks.push(
                  getDocs(
                    query(
                      collection(db, "tickets"),
                      where("created_by_email", "==", em),
                      limit(200)
                    )
                  )
                );
                tasks.push(
                  getDocs(
                    query(
                      collection(db, "tickets"),
                      where("created_by_email", "==", email),
                      limit(200)
                    )
                  )
                );
              }
              let snaps = [];
              const results = tasks.length
                ? await Promise.allSettled(tasks)
                : [];
              for (const r of results) {
                if (r.status === "fulfilled" && r.value) snaps.push(r.value);
              }
              if (!snaps.length) {
                const ticketsList = document.getElementById("ticketsList");
                const tableContainer = document.getElementById(
                  "userTicketsTableContainer"
                );
                if (ticketsList) {
                  ticketsList.innerHTML =
                    '<div class="error-state"><i class="fas fa-exclamation-triangle"></i><h3>Tidak bisa memuat tiket</h3><p>Akses database terbatas atau koneksi bermasalah</p><button class="btn-retry" id="retryTickets">Coba Lagi</button></div>';
                  const btn = document.getElementById("retryTickets");
                  if (btn)
                    btn.addEventListener("click", () =>
                      window.location.reload()
                    );
                }
                if (tableContainer) tableContainer.style.display = "none";
                return;
              }
              const map = new Map();
              for (const snap of snaps) {
                snap.forEach((docSnap) => {
                  map.set(docSnap.id, docSnap.data());
                });
              }
              if (map.size === 0) {
                try {
                  const fallback = await getDocs(
                    query(collection(db, "tickets"), limit(200))
                  );
                  fallback.forEach((docSnap) => {
                    const d = docSnap.data();
                    const uidMatch =
                      uid &&
                      (d.user_id === uid ||
                        d.userId === uid ||
                        d.created_by === uid ||
                        d.created_by_uid === uid);
                    const emailMatch =
                      email &&
                      [d.user_email, d.email, d.created_by_email].some(
                        (v) => (v || "").toLowerCase() === email.toLowerCase()
                      );
                    if (uidMatch || emailMatch) map.set(docSnap.id, d);
                  });
                } catch (_) {}
              }
              let list = Array.from(map.entries()).map(([id, data]) => ({
                id,
                ...data,
              }));
              try {
                list = list.filter((t) => !t.deleted);
              } catch (_) {}
              list.sort((a, b) => {
                const toDate = (v) =>
                  v?.toDate ? v.toDate() : v ? new Date(v) : new Date(0);
                const aDate = toDate(a.created_at || a.createdAt);
                const bDate = toDate(b.created_at || b.createdAt);
                return bDate - aDate;
              });
              const ticketsList = document.getElementById("ticketsList");
              const tableContainer = document.getElementById(
                "userTicketsTableContainer"
              );
              const ticketsFooter =
                document.getElementById("ticketsListFooter");
              if (!ticketsList) return;
              if (!list.length) {
                ticketsList.innerHTML =
                  '<div class="empty-state"><i class="fas fa-ticket-alt"></i><h3>No tickets yet</h3><p>Submit your first support ticket above</p></div>';
                if (ticketsFooter) ticketsFooter.innerHTML = "";
              } else {
                const renderLimit = 10;
                window.__userTicketsList = list;
                window.__userTicketsLimit = renderLimit;
                const render = (limit) => {
                  const html = list
                    .slice(0, limit)
                    .map((t) => {
                      const ca = t.created_at || t.createdAt || null;
                      const created = ca?.toDate
                        ? ca.toDate().toLocaleDateString()
                        : ca || "";
                      const statusRaw =
                        t.status ||
                        t.status_ticket ||
                        (t.qa === "Finish" ? "Resolved" : t.qa || "Open");
                      const status = statusRaw;
                      const statusNorm = String(statusRaw).trim().toLowerCase();
                      const deviceDisplay =
                        t.device && String(t.device).trim()
                          ? t.device
                          : t.assignment_activity || t.activity || "";
                      const locationDisplay =
                        t.location && String(t.location).trim()
                          ? t.location
                          : t.assignment_location || "";
                      const isAssigned = !!(
                        (t.action_by &&
                          String(t.action_by).toLowerCase() !== "unassigned") ||
                        t.assigned_to
                      );
                      const emailLower = (email || "").toLowerCase();
                      const tEmail = (
                        t.user_email ||
                        t.email ||
                        t.created_by_email ||
                        t.userEmail ||
                        ""
                      ).toLowerCase();
                      const emailOwner =
                        !!emailLower && !!tEmail && tEmail === emailLower;
                      const uidOwner =
                        (t.user_id && t.user_id === (uid || "")) ||
                        (t.created_by && t.created_by === (uid || "")) ||
                        (t.userId && t.userId === (uid || "")) ||
                        (t.created_by_uid && t.created_by_uid === (uid || ""));
                      const canDelete =
                        statusNorm === "open" &&
                        !isAssigned &&
                        (uidOwner || emailOwner);
                      const deleteBtn = `<div class="ticket-actions"><button class="btn-delete-ticket" data-ticket-id="${
                        t.id
                      }" data-ticket-code="${t.code || ""}" ${
                        canDelete ? "" : "disabled"
                      }><i class="fas fa-trash"></i> Delete</button></div>`;
                      return `<div class="ticket-item"><div class="ticket-content"><div class="ticket-header"><div class="ticket-code">${
                        t.code || ""
                      }</div><div class="ticket-priority">${
                        t.priority || "Medium"
                      }</div></div><h4 class="ticket-subject">${
                        t.subject && String(t.subject).trim()
                          ? t.subject
                          : t.assignment_subject || ""
                      }</h4><div class="ticket-meta"><span class="ticket-device">${
                        deviceDisplay || "Unknown"
                      }</span><span class="ticket-location">${
                        locationDisplay || ""
                      }</span><span class="ticket-status">${status}</span><span class="ticket-date">${created}</span></div>${deleteBtn}</div></div>`;
                    })
                    .join("");
                  ticketsList.innerHTML = html;
                  try {
                    const btns =
                      ticketsList.querySelectorAll(".btn-delete-ticket");
                    btns.forEach((btn) => {
                      btn.addEventListener("click", async (e) => {
                        e.preventDefault();
                        const id = btn.getAttribute("data-ticket-id");
                        const code = btn.getAttribute("data-ticket-code") || "";
                        try {
                          const confirm = await Swal.fire({
                            title: "Delete Ticket?",
                            text: code
                              ? `Ticket ${code} will be deleted`
                              : "This action cannot be undone",
                            icon: "warning",
                            showCancelButton: true,
                            confirmButtonText: "Delete",
                            confirmButtonColor: "#ef4444",
                            cancelButtonText: "Cancel",
                          });
                          if (!confirm.isConfirmed) return;
                        } catch (_) {}
                        try {
                          await updateDoc(doc(db, "tickets", id), {
                            deleted: true,
                            deleted_by: uid || "",
                            deleted_by_email: (email || "").toLowerCase(),
                            last_updated: serverTimestamp(),
                          });
                          list = list.filter((t) => t.id !== id);
                          render(
                            Math.min(
                              window.__userTicketsLimit || limit,
                              list.length
                            )
                          );
                        } catch (err) {
                          try {
                            await Swal.fire({
                              icon: "error",
                              title: "Delete Failed",
                              text: err?.message || "",
                            });
                          } catch (_) {}
                        }
                      });
                    });
                  } catch (_) {}
                  if (ticketsFooter) {
                    if (list.length > limit) {
                      ticketsFooter.innerHTML =
                        limit === renderLimit
                          ? `
                        <div style="display:flex; gap:0.5rem; align-items:center;">
                          <button id="btnShowMoreTickets" class="btn-secondary">Show More</button>
                          <button id="btnShowAllTickets" class="btn-secondary">Show All</button>
                        </div>
                      `
                          : `
                        <div style="display:flex; gap:0.5rem; align-items:center;">
                          <button id="btnShowMoreTickets" class="btn-secondary">Show More</button>
                          <button id="btnShowAllTickets" class="btn-secondary">Show All</button>
                          <button id="btnCloseTickets" class="btn-secondary">Close</button>
                        </div>
                      `;
                      const btnMore =
                        document.getElementById("btnShowMoreTickets");
                      const btnAll =
                        document.getElementById("btnShowAllTickets");
                      const btnClose =
                        document.getElementById("btnCloseTickets");
                      if (btnMore)
                        btnMore.onclick = () => {
                          const next = Math.min(
                            list.length,
                            (window.__userTicketsLimit || limit) + 10
                          );
                          window.__userTicketsLimit = next;
                          render(next);
                        };
                      if (btnAll)
                        btnAll.onclick = () => {
                          window.__userTicketsLimit = list.length;
                          render(list.length);
                        };
                      if (btnClose)
                        btnClose.onclick = () => {
                          window.__userTicketsLimit = renderLimit;
                          render(renderLimit);
                        };
                    } else {
                      ticketsFooter.innerHTML = "";
                    }
                  }
                };
                render(renderLimit);
              }
              if (tableContainer) tableContainer.style.display = "none";

              try {
                const openEl = document.getElementById("openTickets");
                const resEl = document.getElementById("resolvedTickets");
                if (openEl || resEl) {
                  let open = 0,
                    resolved = 0;
                  for (const t of list) {
                    const st =
                      t.status ||
                      t.status_ticket ||
                      (t.qa === "Finish" ? "Resolved" : t.qa || "Open");
                    if (st === "Resolved") resolved++;
                    else open++;
                  }
                  if (openEl) openEl.textContent = String(open);
                  if (resEl) resEl.textContent = String(resolved);
                }
              } catch (_) {}

              const ticketForm = document.getElementById("ticketForm");
              if (ticketForm) {
                const userIdInput = document.getElementById("user_id");
                const userNameInput = document.getElementById("user_name");
                const userEmailInput = document.getElementById("user_email");
                const createdAtInput = document.getElementById("created_at");
                if (userIdInput) userIdInput.value = uid || "";
                if (userNameInput)
                  userNameInput.value = (email || "").split("@")[0] || "User";
                if (userEmailInput) userEmailInput.value = email || "";
                if (createdAtInput)
                  createdAtInput.value = new Date().toISOString();

                ticketForm.addEventListener("submit", async (e) => {
                  e.preventDefault();
                  const submitBtn = document.getElementById("submitTicketBtn");
                  const errEl = document.getElementById("ticketErrorMessage");
                  const okEl = document.getElementById("ticketSuccessMessage");
                  try {
                    if (submitBtn) submitBtn.disabled = true;
                    const fd = new FormData(ticketForm);
                    const data = Object.fromEntries(fd.entries());
                    const payload = {
                      user_id: uid || "",
                      user_name: (email || "").split("@")[0] || "User",
                      user_email: (email || "").toLowerCase(),
                      user_department: data.user_department || "",
                      inventory: data.inventory || "",
                      device: data.device || "",
                      location: data.location || "",
                      priority: data.priority || "Medium",
                      subject: data.subject || "",
                      message: data.message || "",
                      status: "Open",
                      created_at: serverTimestamp(),
                    };
                    if (!payload.user_department) {
                      try {
                        const udoc = await getDoc(doc(db, "users", uid));
                        if (udoc.exists()) {
                          const ud = udoc.data() || {};
                          if (ud.department)
                            payload.user_department = ud.department;
                        } else {
                          const adoc = await getDoc(doc(db, "admins", uid));
                          if (adoc.exists()) {
                            const ad = adoc.data() || {};
                            if (ad.department)
                              payload.user_department = ad.department;
                          }
                        }
                      } catch (_) {}
                    }
                    try {
                      console.info("Submitting ticket payload", {
                        uid,
                        email,
                        subject: payload.subject,
                        location: payload.location,
                        priority: payload.priority,
                      });
                    } catch (_) {}
                    const docRef = await addDoc(
                      collection(db, "tickets"),
                      payload
                    );
                    try {
                      const code = window.generateTicketId(
                        payload.user_department || "",
                        payload.device || "",
                        payload.location || "",
                        docRef.id,
                        ""
                      );
                      await updateDoc(docRef, { code });
                    } catch (_) {}
                    if (okEl) {
                      okEl.textContent = "Ticket submitted successfully";
                      okEl.style.display = "block";
                      setTimeout(() => (okEl.style.display = "none"), 4000);
                    }
                    ticketForm.reset();
                    const reloadSnaps = await Promise.all([
                      getDocs(
                        query(
                          collection(db, "tickets"),
                          where("user_id", "==", uid),
                          orderBy("created_at", "desc"),
                          limit(20)
                        )
                      ),
                    ]);
                    const rmap = new Map();
                    for (const s of reloadSnaps) {
                      s.forEach((ds) => rmap.set(ds.id, ds.data()));
                    }
                    const rlist = Array.from(rmap.entries()).map(
                      ([id, data]) => ({ id, ...data })
                    );
                    rlist.sort((a, b) => {
                      const toDate = (v) =>
                        v?.toDate ? v.toDate() : v ? new Date(v) : new Date(0);
                      const aDate = toDate(a.created_at || a.createdAt);
                      const bDate = toDate(b.created_at || b.createdAt);
                      return bDate - aDate;
                    });
                    const html2 = rlist
                      .slice(0, 10)
                      .map((t) => {
                        const ca = t.created_at || t.createdAt || null;
                        const created = ca?.toDate
                          ? ca.toDate().toLocaleDateString()
                          : ca || "";
                        const statusRaw =
                          t.status ||
                          t.status_ticket ||
                          (t.qa === "Finish" ? "Resolved" : t.qa || "Open");
                        const status = statusRaw;
                        const statusNorm = String(statusRaw)
                          .trim()
                          .toLowerCase();
                        const deviceDisplay =
                          t.device && String(t.device).trim()
                            ? t.device
                            : t.assignment_activity || t.activity || "";
                        const locationDisplay =
                          t.location && String(t.location).trim()
                            ? t.location
                            : t.assignment_location || "";
                        const isAssigned = !!(
                          (t.action_by &&
                            String(t.action_by).toLowerCase() !==
                              "unassigned") ||
                          t.assigned_to
                        );
                        const emailLower = (email || "").toLowerCase();
                        const tEmail = (
                          t.user_email ||
                          t.email ||
                          t.created_by_email ||
                          t.userEmail ||
                          ""
                        ).toLowerCase();
                        const emailOwner =
                          !!emailLower && !!tEmail && tEmail === emailLower;
                        const uidOwner =
                          (t.user_id && t.user_id === (uid || "")) ||
                          (t.created_by && t.created_by === (uid || "")) ||
                          (t.userId && t.userId === (uid || "")) ||
                          (t.created_by_uid &&
                            t.created_by_uid === (uid || ""));
                        const canDelete =
                          statusNorm === "open" &&
                          !isAssigned &&
                          (uidOwner || emailOwner);
                        const deleteBtn = `<div class="ticket-actions"><button class="btn-delete-ticket" data-ticket-id="${
                          t.id
                        }" data-ticket-code="${t.code || ""}" ${
                          canDelete ? "" : "disabled"
                        }><i class="fas fa-trash"></i> Delete</button></div>`;
                        return `<div class="ticket-item"><div class="ticket-content"><div class="ticket-header"><div class="ticket-code">${
                          t.code || ""
                        }</div><div class="ticket-priority">${
                          t.priority || "Medium"
                        }</div></div><h4 class="ticket-subject">${
                          t.subject && String(t.subject).trim()
                            ? t.subject
                            : t.assignment_subject || ""
                        }</h4><div class="ticket-meta"><span class="ticket-device">${
                          deviceDisplay || "Unknown"
                        }</span><span class="ticket-location">${
                          locationDisplay || ""
                        }</span><span class="ticket-status">${status}</span><span class="ticket-date">${created}</span></div>${deleteBtn}</div></div>`;
                      })
                      .join("");
                    ticketsList.innerHTML = html2;
                    try {
                      const btns =
                        ticketsList.querySelectorAll(".btn-delete-ticket");
                      btns.forEach((btn) => {
                        btn.addEventListener("click", async (e) => {
                          e.preventDefault();
                          const id = btn.getAttribute("data-ticket-id");
                          const code =
                            btn.getAttribute("data-ticket-code") || "";
                          try {
                            const confirm = await Swal.fire({
                              title: "Delete Ticket?",
                              text: code
                                ? `Ticket ${code} will be deleted`
                                : "This action cannot be undone",
                              icon: "warning",
                              showCancelButton: true,
                              confirmButtonText: "Delete",
                              confirmButtonColor: "#ef4444",
                              cancelButtonText: "Cancel",
                            });
                            if (!confirm.isConfirmed) return;
                          } catch (_) {}
                          try {
                            await updateDoc(doc(db, "tickets", id), {
                              deleted: true,
                              deleted_by: uid || "",
                              deleted_by_email: (email || "").toLowerCase(),
                              last_updated: serverTimestamp(),
                            });
                            const idx = window.__userTicketsList.findIndex(
                              (x) => x.id === id
                            );
                            if (idx >= 0)
                              window.__userTicketsList.splice(idx, 1);
                            const next = Math.min(
                              window.__userTicketsLimit || 10,
                              window.__userTicketsList.length
                            );
                            render(next);
                          } catch (err) {
                            try {
                              await Swal.fire({
                                icon: "error",
                                title: "Delete Failed",
                                text: err?.message || "",
                              });
                            } catch (_) {}
                          }
                        });
                      });
                    } catch (_) {}
                    if (ticketsFooter) {
                      window.__userTicketsList = rlist;
                      window.__userTicketsLimit = 10;
                      if (rlist.length > 10) {
                        ticketsFooter.innerHTML = `
                          <div style="display:flex; gap:0.5rem; align-items:center;">
                            <button id="btnShowMoreTickets" class="btn-secondary">Show More</button>
                            <button id="btnShowAllTickets" class="btn-secondary">Show All</button>
                          </div>
                        `;
                        const btnMore =
                          document.getElementById("btnShowMoreTickets");
                        const btnAll =
                          document.getElementById("btnShowAllTickets");
                        const btnClose =
                          document.getElementById("btnCloseTickets");
                        if (btnMore)
                          btnMore.onclick = () => {
                            const next = Math.min(
                              rlist.length,
                              (window.__userTicketsLimit || 10) + 10
                            );
                            window.__userTicketsLimit = next;
                            const htmlNext = rlist
                              .slice(0, next)
                              .map((t) => {
                                const ca = t.created_at || t.createdAt || null;
                                const created = ca?.toDate
                                  ? ca.toDate().toLocaleDateString()
                                  : ca || "";
                                const status =
                                  t.status ||
                                  t.status_ticket ||
                                  (t.qa === "Finish"
                                    ? "Resolved"
                                    : t.qa || "Open");
                                const deviceDisplay =
                                  t.device && String(t.device).trim()
                                    ? t.device
                                    : t.assignment_activity || t.activity || "";
                                const locationDisplay =
                                  t.location && String(t.location).trim()
                                    ? t.location
                                    : t.assignment_location || "";
                                return `<div class="ticket-item"><div class="ticket-content"><div class="ticket-header"><div class="ticket-code">${
                                  t.code || ""
                                }</div><div class="ticket-priority">${
                                  t.priority || "Medium"
                                }</div></div><h4 class="ticket-subject">${
                                  t.subject && String(t.subject).trim()
                                    ? t.subject
                                    : t.assignment_subject || ""
                                }</h4><div class="ticket-meta"><span class="ticket-device">${
                                  deviceDisplay || "Unknown"
                                }</span><span class="ticket-location">${
                                  locationDisplay || ""
                                }</span><span class="ticket-status">${status}</span><span class="ticket-date">${created}</span></div></div></div>`;
                              })
                              .join("");
                            ticketsList.innerHTML = htmlNext;
                            ticketsFooter.innerHTML = `
                              <div style="display:flex; gap:0.5rem; align-items:center;">
                                <button id="btnShowMoreTickets" class="btn-secondary">Show More</button>
                                <button id="btnShowAllTickets" class="btn-secondary">Show All</button>
                                <button id="btnCloseTickets" class="btn-secondary">Close</button>
                              </div>
                            `;
                            const btnClose =
                              document.getElementById("btnCloseTickets");
                            if (btnClose)
                              btnClose.onclick = () => {
                                window.__userTicketsLimit = 10;
                                const htmlReset = rlist
                                  .slice(0, 10)
                                  .map((t) => {
                                    const ca =
                                      t.created_at || t.createdAt || null;
                                    const created = ca?.toDate
                                      ? ca.toDate().toLocaleDateString()
                                      : ca || "";
                                    const status =
                                      t.status ||
                                      t.status_ticket ||
                                      (t.qa === "Finish"
                                        ? "Resolved"
                                        : t.qa || "Open");
                                    const deviceDisplay =
                                      t.device && String(t.device).trim()
                                        ? t.device
                                        : t.assignment_activity ||
                                          t.activity ||
                                          "";
                                    const locationDisplay =
                                      t.location && String(t.location).trim()
                                        ? t.location
                                        : t.assignment_location || "";
                                    return `<div class=\"ticket-item\"><div class=\"ticket-content\"><div class=\"ticket-header\"><div class=\"ticket-code\">${
                                      t.code || ""
                                    }</div><div class=\"ticket-priority\">${
                                      t.priority || "Medium"
                                    }</div></div><h4 class=\"ticket-subject\">${
                                      t.subject && String(t.subject).trim()
                                        ? t.subject
                                        : t.assignment_subject || ""
                                    }</h4><div class=\"ticket-meta\"><span class=\"ticket-device\">${
                                      deviceDisplay || "Unknown"
                                    }</span><span class=\"ticket-location\">${
                                      locationDisplay || ""
                                    }</span><span class=\"ticket-status\">${status}</span><span class=\"ticket-date\">${created}</span></div></div></div>`;
                                  })
                                  .join("");
                                ticketsList.innerHTML = htmlReset;
                                ticketsFooter.innerHTML = `
                                  <div style=\"display:flex; gap:0.5rem; align-items:center;\">
                                    <button id=\"btnShowMoreTickets\" class=\"btn-secondary\">Show More</button>
                                    <button id=\"btnShowAllTickets\" class=\"btn-secondary\">Show All</button>
                                  </div>
                                `;
                              };
                          };
                        if (btnAll)
                          btnAll.onclick = () => {
                            window.__userTicketsLimit = rlist.length;
                            const htmlAll = rlist
                              .map((t) => {
                                const ca = t.created_at || t.createdAt || null;
                                const created = ca?.toDate
                                  ? ca.toDate().toLocaleDateString()
                                  : ca || "";
                                const status =
                                  t.status ||
                                  t.status_ticket ||
                                  (t.qa === "Finish"
                                    ? "Resolved"
                                    : t.qa || "Open");
                                const deviceDisplay =
                                  t.device && String(t.device).trim()
                                    ? t.device
                                    : t.assignment_activity || t.activity || "";
                                const locationDisplay =
                                  t.location && String(t.location).trim()
                                    ? t.location
                                    : t.assignment_location || "";
                                return `<div class="ticket-item"><div class="ticket-content"><div class="ticket-header"><div class="ticket-code">${
                                  t.code || ""
                                }</div><div class="ticket-priority">${
                                  t.priority || "Medium"
                                }</div></div><h4 class="ticket-subject">${
                                  t.subject && String(t.subject).trim()
                                    ? t.subject
                                    : t.assignment_subject || ""
                                }</h4><div class="ticket-meta"><span class="ticket-device">${
                                  deviceDisplay || "Unknown"
                                }</span><span class="ticket-location">${
                                  locationDisplay || ""
                                }</span><span class="ticket-status">${status}</span><span class="ticket-date">${created}</span></div></div></div>`;
                              })
                              .join("");
                            ticketsList.innerHTML = htmlAll;
                            ticketsFooter.innerHTML = `
                              <div style="display:flex; gap:0.5rem; align-items:center;">
                                <button id="btnShowMoreTickets" class="btn-secondary">Show More</button>
                                <button id="btnShowAllTickets" class="btn-secondary">Show All</button>
                                <button id="btnCloseTickets" class="btn-secondary">Close</button>
                              </div>
                            `;
                            const btnClose2 =
                              document.getElementById("btnCloseTickets");
                            if (btnClose2)
                              btnClose2.onclick = () => {
                                window.__userTicketsLimit = 10;
                                const htmlReset = rlist
                                  .slice(0, 10)
                                  .map((t) => {
                                    const ca =
                                      t.created_at || t.createdAt || null;
                                    const created = ca?.toDate
                                      ? ca.toDate().toLocaleDateString()
                                      : ca || "";
                                    const status =
                                      t.status ||
                                      t.status_ticket ||
                                      (t.qa === "Finish"
                                        ? "Resolved"
                                        : t.qa || "Open");
                                    const deviceDisplay =
                                      t.device && String(t.device).trim()
                                        ? t.device
                                        : t.assignment_activity ||
                                          t.activity ||
                                          "";
                                    const locationDisplay =
                                      t.location && String(t.location).trim()
                                        ? t.location
                                        : t.assignment_location || "";
                                    return `<div class=\"ticket-item\"><div class=\"ticket-content\"><div class=\"ticket-header\"><div class=\"ticket-code\">${
                                      t.code || ""
                                    }</div><div class=\"ticket-priority\">${
                                      t.priority || "Medium"
                                    }</div></div><h4 class=\"ticket-subject\">${
                                      t.subject && String(t.subject).trim()
                                        ? t.subject
                                        : t.assignment_subject || ""
                                    }</h4><div class=\"ticket-meta\"><span class=\"ticket-device\">${
                                      deviceDisplay || "Unknown"
                                    }</span><span class=\"ticket-location\">${
                                      locationDisplay || ""
                                    }</span><span class=\"ticket-status\">${status}</span><span class=\"ticket-date\">${created}</span></div></div></div>`;
                                  })
                                  .join("");
                                ticketsList.innerHTML = htmlReset;
                                ticketsFooter.innerHTML = `
                                  <div style=\"display:flex; gap:0.5rem; align-items:center;\">
                                    <button id=\"btnShowMoreTickets\" class=\"btn-secondary\">Show More</button>
                                    <button id=\"btnShowAllTickets\" class=\"btn-secondary\">Show All</button>
                                  </div>
                                `;
                              };
                          };
                        if (btnClose)
                          btnClose.onclick = () => {
                            window.__userTicketsLimit = 10;
                            const htmlReset = rlist
                              .slice(0, 10)
                              .map((t) => {
                                const ca = t.created_at || t.createdAt || null;
                                const created = ca?.toDate
                                  ? ca.toDate().toLocaleDateString()
                                  : ca || "";
                                const status =
                                  t.status ||
                                  t.status_ticket ||
                                  (t.qa === "Finish"
                                    ? "Resolved"
                                    : t.qa || "Open");
                                const deviceDisplay =
                                  t.device && String(t.device).trim()
                                    ? t.device
                                    : t.assignment_activity || t.activity || "";
                                const locationDisplay =
                                  t.location && String(t.location).trim()
                                    ? t.location
                                    : t.assignment_location || "";
                                return `<div class="ticket-item"><div class="ticket-content"><div class="ticket-header"><div class="ticket-code">${
                                  t.code || ""
                                }</div><div class="ticket-priority">${
                                  t.priority || "Medium"
                                }</div></div><h4 class="ticket-subject">${
                                  t.subject && String(t.subject).trim()
                                    ? t.subject
                                    : t.assignment_subject || ""
                                }</h4><div class="ticket-meta"><span class="ticket-device">${
                                  deviceDisplay || "Unknown"
                                }</span><span class="ticket-location">${
                                  locationDisplay || ""
                                }</span><span class="ticket-status">${status}</span><span class="ticket-date">${created}</span></div></div></div>`;
                              })
                              .join("");
                            ticketsList.innerHTML = htmlReset;
                          };
                      } else {
                        ticketsFooter.innerHTML = "";
                      }
                    }
                  } catch (err) {
                    if (errEl) {
                      errEl.textContent =
                        err?.message || "Failed to submit ticket";
                      errEl.style.display = "block";
                      setTimeout(() => (errEl.style.display = "none"), 5000);
                    }
                  } finally {
                    if (submitBtn) submitBtn.disabled = false;
                  }
                });
              }
            } catch (_) {
              showMain();
            }
          });
        } catch (_) {
          showMain();
        }
      });
    </script>
  </body>
</html>
